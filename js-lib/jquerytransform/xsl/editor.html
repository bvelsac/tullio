<html>
<head>
	<title>Full Text</title>
	<style>
	body {font-family: sans-serif;}
	table {font-size: 12px; }
	#remove {width: 100%;}
	#header {width: 100%;}
	#header div {background-color: pink;  margin: 0.5%; float: left; }
	#meeting {width: 19%;}
	#logo {width: 59%;}
	#free {width: 19%;}
	#navigation ul li {list-style-type: none; display: inline;}
	#texts {background-color: silver;}
	#hidden {background-color: yellow;}
	td {border: thin dotted navy;}
	.ruby td {background-color: #ff3333;}
	.edited {background-color: #66ff66;}
	</style>

	<style id="styles" type="text/css">

		div.editable
		{
			border: solid 2px Transparent;
			padding-left: 15px;
			padding-right: 15px;
		}
/*
		div.editable:hover
		{
			border-color: black;
		}
*/

	</style>
	
	<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
	<script src="ckeditor/_samples/sample.js" type="text/javascript"></script>
	<link href="ckeditor/_samples/sample.css" rel="stylesheet" type="text/css" />

	
	<script language="javascript" src="jquerytransform/js/jquery-1.6.4.js"></script>
	<script language="javascript" src="jquerytransform/js/jquery.transform.js"></script>
	<script language="javascript" src="jquerytransform/js/examplefunctions.js"></script>
	
	<script type="text/javascript" src="jquery-ui-1.8.16.custom.min.js"></script>
	
	<script type="text/javascript" src="jquery.layout.js"></script>
	<link href="jquery.layout.css" rel="stylesheet" type="text/css" />

	
	<script>
	
	var updateCounter = 0;
	var scrollState = 0;
	var lastVisible = -1;
	var start = "";
	var stop = "";
	var visibleRows = [];
	var visibles = "";
	var meeting = "2011-07-24-COMENVLEEF"; 
	var ids = "";
	var edited = "";
	var editor;	
	var popupStatus = 0;
	var pause = 0;
	var rowId;
	
	function loadPopup() {
	//loading popup with jQuery magic!
	//loads popup only if it is disabled
		if(popupStatus==0){
			$("#backgroundPopup").css({
					"opacity": "0.7"
			});
			$("#backgroundPopup").fadeIn("slow");
			$("#popupContact").fadeIn("slow");
			popupStatus = 1;
		}
	}


//centering popup
function centerPopup(){
//request data for centering
var windowWidth = document.documentElement.clientWidth;
var windowHeight = document.documentElement.clientHeight;
var popupHeight = $("#popupContact").height();
var popupWidth = $("#popupContact").width();
//centering
$("#popupContact").css({
"position": "absolute",
"top": "10%",
"left": "10%"
});
//only need force for IE6

$("#backgroundPopup").css({
"height": windowHeight
});

}
	
	

	

function secondstep(xml, xsl, xmlorig) {
	$("#hidden").transform({async:false, xmlobj:xml, xsl:"jquerytransform/xsl/group.xsl"});
	// replace
	var rows = $("#hidden > tr");
	console.log(rows);
	$(ids).wrapAll("<span id='replace' />");
	$("#replace").replaceWith(rows);
	$("#" + edited.replace(/\./g,"\\.")).addClass('edited');
	
}


function isVisible(id) {
	var cutoffTop = $(window).scrollTop();
	var cutoffBottom =  $(window).scrollTop() + $(window).height();
	var currTop = $("#" + id).offset().top;
	var currBottom = $("#" + id).offset().top + $("#" + id).height();
	
	if ( currTop > cutoffTop || currBottom  > cutoffTop || (currTop < cutoffTop && currBottom  > cutoffBottom) ) {
		return true;
		
	}
	else return false;
	
}




function updateVisibleTextsWhenEdit(rowId, colType) {
		// refreshes in two steps if there is a row in edit mode
	// colType is original / translation
	// Take the current row and walk backwards to find the first visible row
	
		var currId = rowId;
		while (isVisible(currId)) {
			console.log(currId);
			currId = $("#" + currId).prev().id;
			
		}
}




function updateVisibleTextsNoEdit() {
	
	
	$('#text-table tr').removeClass('ruby');

	// simply loop over all rows
	
	if (pause == 0) {
	
	visibles = "";
	visibleRows.length = 0;
	var cutoffTop = $(window).scrollTop();
	var cutoffBottom =  $(window).scrollTop() + $(window).height();
	var switchFirst = 0;	
    $('#text-table > tbody > tr').each(function() {
				var currTop = $(this).offset().top;
				var currBottom = $(this).offset().top + $(this).height();
				// console.log(this.id + ': ' + cutoffTop + " " + cutoffBottom + " " + currTop + currBottom);
				
        if (currTop > cutoffTop || currBottom  > cutoffTop || (currTop < cutoffTop && currBottom  > cutoffBottom)) {
						// console.log('row ' + this.id + ' is visible');

						visibleRows.push(this.id);
						visibles += "#" + this.id + ",";
						
						if (switchFirst == 0) {
							start = this.id;
							switchFirst = 1;
						}
						
						if ($(this).offset().top > cutoffBottom) {
							stop = this.id;
							return false; // stops the iteration after the first invisible row 
						}
        }
    });
		
		scrollState = 0;
	}
	
	updateCounter++;
	console.log("start: " + start + " stop: " + stop);
//	console.log(visibleRows);
	ids = "#" + visibleRows.toString().replace(/,/g, ',#');
	ids = ids.replace(/\./g,"\\.");
	console.log(ids);

	// highlight refreshed rows
	$(ids).addClass('ruby');
	// create request
	var request = "http://localhost:8080/exist/xquery/return-combined.xq?m=" + meeting + "&start=" + start.substring(1) + "&stop=" + stop.substring(1);
	console.log(request);
	
	
	
	// refresh the visible rows
	// query the DB for event and text data
	$.transform({dataType:"xml", success:secondstep, xml:request, xsl: "jquerytransform/xsl/addclipref.xsl"});
		
	// wrap the rows in a div
	
	
	
	setTimeout("updateVisibleTexts()", 5000);

}  

function initialize(xml, xsl, xmlorig) {
	$("#result").transform({xmlobj:xml, xsl:"jquerytransform/xsl/group.xsl"});
}

$().ready(function(){
		
		
		CKEDITOR.replace( 'editor1', 
		{
			height: "100%",
			resize_enabled : true,
			toolbar : [ [ 'Source', '-', 'Bold', 'Italic', 'Underline', 'Strike','-','Link', '-', 'MyButton' ] ]
		});
		
		$('body').layout({ applyDefaultStyles: true });
		
		$.transform({dataType:"xml", success:initialize, xml: "http://localhost:8080/exist/xquery/return-combined.xq?m=2011-07-24-COMENVLEEF", xsl: "jquerytransform/xsl/addclipref.xsl"});
		
		// setTimeout("updateVisibleTexts()", 5000);
		
		$(window).scroll(function(){
			scrollState = 1;
		});
						
		$('#logo').click(function() {
				alert("clicked");
				function popitup2() {
					newwindow2=window.open('#','name','height=200,width=150');
					var tmp = newwindow2.document;
					tmp.write('<html><head><title>EDITOR</title>');
					tmp.write('<link rel="stylesheet" href="js.css">');
					tmp.write('</head><body><p>this is once again a popup.</p>');
					tmp.write('<p><a href="javascript:alert(self.location.href)">view location</a>.</p>');
					tmp.write('<p><a href="javascript:self.close()">close</a> the popup.</p>');
					tmp.write('</body></html>');
					tmp.close();
					setTimeout('$("body", newwindow2.document).html("<p>MIAUW</p>")', 100);
}
				popitup2();
				$("#editingArea").css("height", "50%");
		});
		
		$("#text-table td").live("click", function(){
				pause = 1;
				edited = this.id;
				rowId = this.parentNode.id;
				$(this).addClass("edited");
				updateVisibleTextsWhenEdit(rowId);
			//	if ( editor )	editor.destroy();
			//	editor = CKEDITOR.replace( this, {
			//			toolbar : [['Source', 'Transform']]
			//	});
		});
		
});

	</script>
	
	
</head>
<body >
<div  class="ui-layout-north">
<div id="header">
	<div id="meeting">iiiiiiiiiiiiiii</div>
	<div id="logo">iiiiiiiiii</div>
	<div id="free">iiiiiiiiii</div>
</div>
<div id="navigation">
	<ul>
		<li>Meeting: <span id="overview"></span></li>
		<li>Go to: <select><option value="overview">Meetings Overview</option><option value="overview">Status Page</option></select></li>
	</ul>
</div>
</div>

<div class="ui-layout-center">
	<div id="tablewrapper">
		<table id="text-table">
			<tbody id ="result">o</tbody>
		</table>
	</div>
</div>
<div class="ui-layout-south">
	<div id="editingArea">
		<textarea id="editor1"></textarea>
	</div>
</div>




<div id="hidden">------</div>





</body>
