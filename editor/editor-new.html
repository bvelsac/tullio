<html>
<head>
	<title>Full Text</title>
	<link rel="stylesheet" type="text/css" href="css/editor.css" />
	<link rel="stylesheet" type="text/css" href="../soundmanager/demo/page-player/css/page-player.css" />
	<link rel="stylesheet" type="text/css" href="../soundmanager/demo/page-player/flashblock/flashblock.css" />
	<link href="../soundmanager/demo/page-player/css/optional-annotations.css" type="text/css" rel="stylesheet">
	<link href="css/player-specific.css" rel="stylesheet" type="text/css" />
	<link href="ckeditor/_samples/sample.css" rel="stylesheet" type="text/css" />
	
	<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
	<script language="javascript" src="../js-lib/jquerytransform/js/jquery-1.6.4.js"></script>
	<script language="javascript" src="../js-lib/jquerytransform/js/jquery.transform.js"></script>
	
	<script type="text/javascript" src="/exist/tullio/soundmanager/script/soundmanager2.js"></script>
	<script type="text/javascript" src="../soundmanager/demo/page-player/script/page-player.js"></script>
	<script type="text/javascript" src="../soundmanager/demo/page-player/script/optional-page-player-metadata.js"></script>
	
	<script type="text/javascript" src="js/player-specific.js"></script>
	<script type="text/javascript" src="/exist/tullio/js-lib/xdate.js"></script>
	
	<script>
		(function($) {
    $.QueryString = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {
            var p=a[i].split('=');
            if (p.length != 2) continue;
            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
    })(window.location.search.substr(1).split('&'))
})(jQuery);

function jq(myid) {
   return '#' + myid.replace(/(:|\.)/g,'\\$1');
 }
	
	
	var dbUrl = "/exist/rest//db/tullio/";
	var newe;
	var noUpdate = false;
	var updateCounter = 0;
	var scrollState = 0;
	var lastVisible = -1;
	var start = "";
	var stop = "";
	var visibleRows = [];
	var visibles = "";
	var meeting = "2011-07-24-COMENVLEEF"; 
	var ids = "";
	var edited = "";
	var editor;	
	var popupStatus = 0;
	var pause = 0;
	var rowId;
	var asString = "";
	
	var titles = null;
	var titlesDoc;
	
	var xval = "bert";
	
	//************** CONFIGURATION *******
	
	var eventTypes = [];
	var speakers = [];
	var government;
	var languages;
	var statusCodes;
	var team;
	
	// define simple configuration for use in CKEditor plugin
	team = ["Lieve", "Daan", "Bienne", "Céline", "Laurence", "Veerle", "Anne", "Johan", "Anita", "Nathalie", "Carine", "Sophie", "Alain", "Jean-Pierre", "Thierry", "Vincent", "Bert", "Michel", "Bérénice", "Isabelle", "Anne"];
	languages = {N: 	[ [ 'Nederlands' ,  'N' ], [ 'Frans' ,  'F' ] ],
	F: [ [ 'néerlandais' ,  'N' ], [ 'français' ,  'F' ] ]};
	
	// load config data from server
	// script could limit the data depending on the meeting, add headers to optimize caching
	var requestConfig = "/exist/tullio/xml/titles.xml";
	
	function setSpeakers(response) {
		var people = response.getElementsByTagName("person");
    var nP = people.length;
		console.log("¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨p" + nP);
		 for (i=0; i<nP; i++) {
			 if (people[i].getAttribute('id')) {
				 console.log(people[i].getAttribute('id'));
				 console.log(people[i].getElementsByTagName('first')[0].firstChild.nodeValue);
				 speakers[i] = [ people[i].getElementsByTagName('last')[0].firstChild.nodeValue + ', ' + people[i].getElementsByTagName('first')[0].firstChild.nodeValue + ' (' + people[i].getAttribute('group') + ')', people[i].getAttribute('id')];
			}
		}	
	}
	
	jQuery.ajax({
			 	type: "GET",
        url:    requestConfig,
        success: setSpeakers,
				dataType: "xml" 
	 });
	
	
	var requestConfig = "/exist/tullio/xq/return-eventTypes.xql?target=editor";
	
	function setEventTypes(response) {
		var people = response.getElementsByTagName("person");
    var nP = people.length;
		console.log("¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨p" + nP);
		 for (i=0; i<nP; i++) {
			 if (people[i].getAttribute('id')) {
				 console.log(people[i].getAttribute('id'));
				 console.log(people[i].getElementsByTagName('first')[0].firstChild.nodeValue);
				 speakers[i] = [ people[i].getElementsByTagName('last')[0].firstChild.nodeValue + ', ' + people[i].getElementsByTagName('first')[0].firstChild.nodeValue + ' (' + people[i].getAttribute('group') + ')', people[i].getAttribute('id')];
			}
		}	
	}
	
	jQuery.ajax({
			 	type: "GET",
        url:    requestConfig,
        success: setSpeakers,
				dataType: "xml" 
	 });
	
	
	
	/* Utility function : get query parameters */
	
var mmm = $.QueryString["m"];
var langChoice = "N";
var meetingDate = mmm.substr(0,10);

var user = $.QueryString["u"];
 
function displayStatus() {
//	 var requestLocks = dbUrl + mmm + "/locks.xml";
	var requestLocks = "/exist/tullio/xq/return-locks.xql?m=" + mmm; 
	 function updateLocks(result) {
		 console.log('update clipstatus');
		 var statusTD;
		 var cell;
		 $(".status").removeClass('locked');
		 $(".status").text(' ');
		 var locks = result.getElementsByTagName("lock");
     var nL = locks.length;
		 console.log("l" + nL);
		 for (i=0; i<nL; i++) {
			 if (locks[i].getAttribute('n')) {
				 statusTD = "status-" + locks[i].getAttribute('n') + "-" + locks[i].getAttribute('v');
				 console.log(statusTD);
				 cell = $(jq(statusTD));
				 console.log(cell);
				 cell.text(locks[i].getAttribute('id'));
				 cell.addClass('locked');
			}
		}
		 
	 }
	 
	 jQuery.ajax({
			 	type: "GET",
        url:    requestLocks,
        success: updateLocks,
				dataType: "xml" 
	 });
	 
 }
 
 function loopDisplayStatus() {
	 displayStatus();
   setTimeout(loopDisplayStatus, 4000);
 }
 
	

function secondstep(xml, xsl, xmlorig) {
	$("#hidden").transform({async:false, xmlobj:xml, xsl:"xsl/group.xsl"});
	// replace
	var rows = $("#hidden > tr");
	console.log("*****");
	console.log("rows: " + rows);
	console.log("rows-lenght: " + rows.length);
	console.log("edited: " + edited);
	console.log("ids: " + ids);

	var origrowIds = ids.split(',');

for (i=0; i<rows.length; i++) {
	//alert(rows[i]);
	console.log("0replace: " + origrowIds[i] + ":" + visibleRows[i] + ":" +edited);
	if (visibleRows[i] != edited.slice(0,-2)) {
		// alert("about to replace, it. " + updateCounter + "." + i)
		// keep editor in place
		
		
		$("#result > tr" + origrowIds[i]).replaceWith($("#hidden > tr:eq(" + 0 + ")"));
		
		
		// alert("done");
	}
	else {
		$("#hidden > tr:eq(0)").remove();
	}
}


if (edited) {
		newPosition = $(jq(edited)).offset().top;
}
	
		
		if (newe && edited) {
			console.log('scrollback');
			$("body").scrollTop($("body").scrollTop() + newPosition - newe);
			newe = $(jq(edited)).offset().top;
		}

displayStatus();


	$("#" + edited.replace(/\./g,"\\.")).addClass('edited');
	
	
}


function isVisible(id) {
	var cutoffTop = $(window).scrollTop();
	var cutoffBottom =  $(window).scrollTop() + $(window).height();
	var currTop = $("#" + id).offset().top;
	var currBottom = $("#" + id).offset().top + $("#" + id).height();


	if ( currTop > cutoffTop || currBottom  > cutoffTop || (currTop < cutoffTop && currBottom  > cutoffBottom) ) {
		return true;
		
	}
	else return false;
	
}

function updateVisibleTexts(once) {
	
	if ( noUpdate ) {
		return true;
	}
	
	
	
	$('#text-table tr').removeClass('ruby');

	// simply loop over all rows
	
	
	// ($("#syncCheck").is(':checked')) console.log("syncCheck -- value: " + $("#syncCheck").is(':checked'));
	
	if (($("#syncCheck").is(':checked'))) {
	
	visibles = "";
	visibleRows.length = 0;
	var cutoffTop = $(window).scrollTop();
	var cutoffBottom =  $(window).scrollTop() + $(window).height();
	var switchFirst = 0;	
	var switchStop = 0;
    $('#text-table > tbody > tr').each(function() {
				var currTop = $(this).offset().top;
				var currBottom = $(this).offset().top + $(this).height();
				// console.log(this.id + ': ' + cutoffTop + " " + cutoffBottom + " " + currTop + currBottom);
				
        if (currTop > cutoffTop || currBottom  > cutoffTop || (currTop < cutoffTop && currBottom  > cutoffBottom)) {
						// console.log('row ' + this.id + ' is visible');

						visibleRows.push(this.id);
						visibles += "#" + this.id + ",";
						
						if (switchFirst == 0) {
							start = this.id;
							switchFirst = 1;
						}
						
						if ($(this).offset().top > cutoffBottom) {
							switchStop = "1";
							stop = this.id;
							return false; // stops the iteration after the first invisible row 
						}
        }
    });
		
		scrollState = 0;
		if (switchStop==0) {
			// all rows are visible
			// take the id of the last row in the table as stop id
			stop = $('#text-table > tbody > tr:last').attr("id");
			console.log("using last row id: " + stop);
		};
	
	updateCounter++;
	console.log("start: " + start + " stop: " + stop);
//	console.log(visibleRows);
	ids = "#" + visibleRows.toString().replace(/,/g, ',#');
	ids = ids.replace(/\./g,"\\.");
	console.log("visible rows: " + ids);

	// highlight refreshed rows
	$(ids).addClass('ruby');
	// create request
	var request = "../xq/return-combined.xql?m=" + mmm + "&start=" + start.substring(1) + "&stop=" + stop.substring(1);
	console.log(request);
	
	
	
	// refresh the visible rows
	// query the DB for event and text data
	$.transform({async:false, dataType:"xml", success:secondstep, xml:request, xsl: "xsl/addclipref.xsl"});
		
	// wrap the rows in a div
	
	
	}
	if (!once) {
		//console.log('in function repeat, par. once :' +  once);
	 setTimeout("updateVisibleTexts(false)", 10000);
	}
}  

function initialize(xml, xsl, xmlorig) {
	
	console.log('initializing...');
	
	jQuery.get( "/exist/tullio/xml/titles.xml", 
		function(data, textStatus, jqXHR) {
			
			console.log(data);
			
			x = data.documentElement;
			xml.getElementsByTagName("all")[0].appendChild(titles);
			
			console.log(xml);
			
			$("#result").transform({cache:false, async:false, dataType:"xml", xmlobj:xml, xsl:"xsl/group.xsl"});
			
		},
		"xml" );
	
		console.log('initializion end');
	
}
/*
function islandSuccess(html,xsl,xml,obj) {
	alert("XML\r\nID: " + obj.xmlid + "\r\nXML: " + $("#" + obj.xmlid).html());
	var yet = $("#island").html();
	$("#result").transform({dataType:"xml", xmlstr:yet, xsl:"xsl/group.xsl"});
}
*/


$().ready(function(){

		
		var asString = "";
		// variable titles does get defined although it cannot be logged
		
		
	      $.each(team, function(val, text) {
						console.log(team);
            $('#person').append(
                $('<option></option>').val(val).html(text)
            );
				});
		
		
		setUpPlayer();
		
		jQuery.get( "/exist/tullio/xml/titles.xml", 
			function(data, textStatus, jqXHR) {
				asString = (new XMLSerializer()).serializeToString(data);
				console.log('assigned var');
			
				
				// titles = data.documentElement;
				
			},
			"xml" );
		
		jQuery.ajax({
         url:    "/exist/tullio/xml/titles.xml",
         success: function(result) {
                      testeee = (new XMLSerializer()).serializeToString(result); 
											console.log(testeee);
											titlesAsString = testeee;
											titlesDoc = result;
											titles = result.documentElement;
                  },
         async:   false,
				 contentType: "text/xml"
    }); 
		

		$('#titles').html(titlesAsString);
		
		
		
		
		
		
		

 
$("#overview").text(mmm);


			$.get("../xq/initialize.xql", {
							"meeting": mmm
					}, function(data) {
							// alert("Data Loaded: " + data);
					});
			
		$.transform({ dataType:"xml", success:initialize, xml: "../xq/return-combined.xql?m=" + mmm, xsl: "xsl/addclipref.xsl"});

	 setTimeout("updateVisibleTexts(false)", 5000);
		
		$(window).scroll(function(){
			scrollState = 1;
		});
		
		// start displaying status codes
		// loopDisplayStatus();
	
		
		
		
						

		$("#text-table td").live("dblclick", 
			function(){
				
				var locked = false;		

editReqId = this.id.slice(1,-2);
author = $("#person option:selected").text();
				
var request = $.ajax({
  url: "../xq/lock.xql",
  type: "POST",
  data: {
							"v": $(this).hasClass("orig") ? "orig" : "trans",
							"n": editReqId,
							"id": author,
							"m": mmm
					},
  async: false
});

request.done(function(msg) {
  msgString =  (new XMLSerializer()).serializeToString(msg);
		console.log( msgString);
		if (msgString.indexOf('success')=='-1') {
			locked = true;
		}
});

request.fail(function(jqXHR, textStatus) {
  alert( "Request failed: " + textStatus );
			locked = true;
});
				




				console.log("clicked: " + this.id);
				// try to acquire a lock
				
				if ( locked ) {alert("locked"); locked= false; return false;}
				
					newe = $(this).offset().top;
				
				// check if another clip is being edited, store text and clean up
				if ( edited != '' ) {
					$("#cke").attr('id', '');
					$(jq(edited)).removeClass("editmode");
					
					
					var clipid = edited.slice(1,-2);
					var stop = $(jq("stopevent-" + clipid)).text();
					
					
					
					var cat = $(this).hasClass("orig") ? "orig" : "trans";
					var status = $(jq("status" + clipid)).text();
					
					var editedcontent = "<wrapper n='" + clipid + "'>" + editor.getData().replace(/[&][#]160[;]/gi," ") + "</wrapper>";
					
					console.log(editedcontent);
					// store everything on the server
					
					
					
					
					$.post("../xq/storeClipEdit.xql", {
							"status": status, 
							"text": editedcontent,
							"cat": cat,
							"start": clipid,
							"stop": stop,
							"meeting": mmm
					}, function(data) {
							// alert("Data Loaded: " + data);
					});
					
				
					console.log(status + cat + clipid + stop + meeting);
					var old = $(this).offset().top;
					
					$.post("../xq/unlock.xql", {
							"v": cat,
							"n": clipid,
							"id": author,
							"m": mmm
					}, function(data) {
							// alert("Data Loaded: " + data);
					});
					editor.destroy();
					}
					// first update the row to be sure we don't loose edits...
				edited = this.id;
						updateVisibleTexts(true);		
				console.log('start editing ' + edited);
				
				rowId = this.parentNode.id;
				$(this).addClass("editmode");
				$(this).children("div:first-child").attr('id', 'cke');
				
					if ( editor ) editor.destroy();

					
					
			
					
	editor = CKEDITOR.replace( 'cke', {
					toolbar: [['internalSync', 'Ajaxsave','Source', 'Transform', 'Maximize', 'Templates', 'Abbr', 'Status']],
					extraPlugins : 'internalSync,ajaxsave,transform,abbr-custom,status',
					disableNativeSpellChecker: false,
					startupFocus: false,
					templates_files : [ 'ckeditor/plugins/templates/templates/default.js' ],
					entities_processNumerical: 'force',
					forcePasteAsPlainText: true
			});


editor.on( 'contentDom', function( evt )
    {
        editor.document.on( 'keyup', function(event)
        {
            if(event.data.$.keyCode == 17) isCtrl=false;
        });

        editor.document.on( 'keydown', function(event)
        {
            if(event.data.$.keyCode == 17) isCtrl=true;
            if(event.data.$.keyCode == 83 && isCtrl == true)
            {
                //The preventDefault() call prevents the browser's save popup to appear.
                //The try statement fixes a weird IE error.
                try {
                    event.data.$.preventDefault();
                } catch(err) {}
console.log('save key');
                //Call to your save function
			lastSound = pagePlayer.lastSound.sID;
			console.log(lastSound);
			soundManager.pause(lastSound);
                return false;
            }
        });

    }, editor.element.$);	
				
				
				
	//			updateVisibleTextsWhenEdit(rowId);
			
	
				}
				
		
		);
		
});

	</script>
	
	
</head>
<body >
<div  class="ui-layout-north">
  <div id="resultpane"></div>
  <div id="header">
    <div id="meeting"><span id="overview"></span>
			<p>Je suis: <select id="person"></select></p>
		</div>
	  <div id="logo"></div>
	  <div id="navigation">
	    <ul>
		    <li><a href="../xq/list-collections.xql">Meetings Overview</a></li>
		    <li><a href="../xq/collection-status.xql">Status Page</a></li>
	    </ul>
    </div>
	  <div id="player">
	    <div id="recording">Audioplayer</div>
	    <div id='controls'>
		    <ul>
			    <li id='toStart'>PLAY FROM START</li>
			    <li id='startStop'>PLAY / PAUSE</li>
			    
			    <li id="rewind">REWIND</li>
					<li id='forward'>FORWARD</li>
		    </ul>
	    </div>

	  </div>
	  <div id="settings">
      <input type="checkbox" id="syncCheck" name="syncing">Keep Syncing</input>
	  </div>
  </div>
</div>
<div id="spacer">&#160;</div>
<div id="centerpane" class="ui-layout-center">

	<div id="tablewrapper">
		<table id="text-table">
			<tbody id ="result"></tbody>
		</table>
	</div>
</div>

<div id="titles"></div>
<div id="hidden"></div>
<div id="debug"></div>

<div id="island"></div>
<div id="ref"></div>
<script>
		window.onbeforeunload = function () {
        return("You're about to quit");
    };
</script>

</body>
